{% extends "base.html" %}

{% block title %}Song Contest - UrVote.Rocks{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">üéµ AI Music Contest</h1>
        <p class="text-xl text-gray-600">Listen, vote, and help choose the best AI-generated songs!</p>
        <p class="text-lg text-primary font-semibold mt-2">Bridging dollars to stable coins</p>
    </div>

    <!-- Contest Info -->
    <div class="bg-gradient-to-r from-primary to-blue-600 text-white p-6 rounded-lg mb-8">
        <div class="text-center">
            <h2 class="text-2xl font-bold mb-2">üá∫üá∏ Best Pro-American AI Song Contest</h2>
            <p class="text-lg opacity-90">Sponsored by PayPortPro: Bridging dollars to stable coins</p>
            <div class="mt-4 flex flex-wrap justify-center gap-4 text-sm">
                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">üéØ Patriotic Theme</span>
                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">üéµ AI-Generated Music</span>
                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">üó≥Ô∏è Community Voting</span>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-4 rounded-lg shadow-md text-center">
            <div class="text-2xl font-bold text-primary" id="totalSongs">0</div>
            <div class="text-sm text-gray-600">Songs</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md text-center">
            <div class="text-2xl font-bold text-secondary" id="totalVotes">0</div>
            <div class="text-sm text-gray-600">Total Votes</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md text-center">
            <div class="text-2xl font-bold text-accent" id="activeVoters">0</div>
            <div class="text-sm text-gray-600">Voters</div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md text-center">
            <div class="text-2xl font-bold text-green-600" id="daysLeft">7</div>
            <div class="text-sm text-gray-600">Days Left</div>
        </div>
    </div>

    <!-- Featured Song -->
    <div class="bg-gradient-to-r from-green-500 to-blue-600 text-white p-6 rounded-lg mb-8">
        <div class="text-center mb-4">
            <h3 class="text-2xl font-bold mb-2">üåü Featured Song of the Week</h3>
            <p class="text-lg opacity-90">Listen to this week's highlighted AI-generated masterpiece</p>
        </div>
        <div class="bg-white bg-opacity-20 p-6 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <div>
                    <h4 class="text-xl font-semibold mb-2">Maga Maga</h4>
                    <p class="text-sm opacity-90 mb-4">A powerful patriotic anthem showcasing the incredible potential of AI music creation</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span class="bg-white bg-opacity-30 px-3 py-1 rounded-full text-sm">üéµ Patriotic</span>
                        <span class="bg-white bg-opacity-30 px-3 py-1 rounded-full text-sm">üá∫üá∏ American</span>
                        <span class="bg-white bg-opacity-30 px-3 py-1 rounded-full text-sm">ü§ñ AI-Generated</span>
                    </div>
                    <div class="flex items-center gap-4 text-sm">
                        <span>üéß 3:45 duration</span>
                        <span>üéØ Contest Entry</span>
                    </div>
                </div>
                <div class="bg-white bg-opacity-10 p-4 rounded-lg">
                    <audio controls class="w-full" preload="none">
                        <source src="/static/audio/payportpro/user/Maga Maga 501.mp3" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    <div class="mt-4 text-center">
                        <button class="bg-white text-green-600 px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                            üó≥Ô∏è Vote for This Song
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Song List -->
    <div class="space-y-4" id="songList">
        <!-- Songs will be populated here -->
        <div class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üéµ</div>
            <p class="text-xl font-medium">No songs available yet</p>
            <p class="text-sm">Songs will appear here once they're approved and voting begins</p>
            <a href="/upload" class="mt-4 inline-block bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-dark transition-colors">
                Submit the First Song
            </a>
        </div>
    </div>

    <!-- Load More Button -->
    <div class="text-center mt-8" id="loadMoreSection" style="display: none;">
        <button id="loadMoreBtn" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
            Load More Songs
        </button>
    </div>
</div>




{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let currentSongs = [];
let currentPage = 1;
let selectedSongId = null;

// Load songs on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSongs();
    updateStats();
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});

// Load songs from API
async function loadSongs(page = 1) {
    try {
        // Calculate offset for pagination
        const limit = 20;
        const offset = (page - 1) * limit;
        
        const url = `/api/songs/?approved_only=true&limit=${limit}&offset=${offset}`;
        console.log('Loading songs from:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const songs = await response.json();
        console.log('Songs loaded:', songs);
        
        if (page === 1) {
            currentSongs = songs || [];
        } else {
            currentSongs = [...currentSongs, ...(songs || [])];
        }
        
        displaySongs();
        updateStats();
        
        // Show/hide load more button (show if we got a full page)
        const loadMoreSection = document.getElementById('loadMoreSection');
        if (songs && songs.length === limit) {
            loadMoreSection.style.display = 'block';
            currentPage = page;
        } else {
            loadMoreSection.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading songs:', error);
        showError('Failed to load songs. Please try again.');
    }
}

// Display songs in the list
function displaySongs() {
    const songList = document.getElementById('songList');
    
    if (currentSongs.length === 0) {
        songList.innerHTML = `
            <div class="text-center py-12 text-gray-500">
                <div class="text-6xl mb-4">üéµ</div>
                <p class="text-xl font-medium">No songs available yet</p>
                <p class="text-sm">Songs will appear here once they're approved and voting begins</p>
                <a href="/upload" class="mt-4 inline-block bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-dark transition-colors">
                    Submit the First Song
                </a>
            </div>
        `;
        return;
    }
    
    songList.innerHTML = currentSongs.map((song, index) => `
        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
            <div class="flex flex-col lg:flex-row gap-6 items-start">
                <!-- Song Info -->
                <div class="flex-1">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-2xl font-bold text-gray-400">#${index + 1}</span>
                                <h3 class="text-xl font-bold text-gray-800">${song.title || 'Untitled Song'}</h3>
                                ${getRankBadge(index + 1)}
                            </div>
                            <div class="space-y-1">
                                <p class="text-gray-600 font-medium">by ${song.artist_name || 'Unknown Artist'}</p>
                                ${song.bio ? `<p class="text-sm text-gray-500">${song.bio.substring(0, 100)}${song.bio.length > 100 ? '...' : ''}</p>` : ''}
                                ${song.location ? `<p class="text-xs text-gray-400">üìç ${song.location}</p>` : ''}
                                <div class="flex items-center gap-2 mt-2">
                                    <a href="https://mysoundcloudpage.com" target="_blank" rel="noopener noreferrer" 
                                       class="inline-flex items-center gap-1 text-primary hover:text-primary-dark transition-colors text-sm font-medium">
                                        <span>üåê</span>
                                        <span>SoundCloud</span>
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-primary">${song.vote_count || 0}</div>
                            <div class="text-sm text-gray-500">votes</div>
                        </div>
                    </div>
                    
                    <!-- Audio Player -->
                    <div class="mb-4">
                        ${song.audio_url ? 
                            `<audio controls class="w-full" preload="none">
                                <source src="${song.audio_url}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>` : 
                            `<div class="bg-gray-100 p-4 rounded-lg text-center text-gray-500">
                                <span>üéµ</span> Audio file not available
                            </div>`
                        }
                    </div>
                    
                    <!-- Song Details -->
                    <div class="flex flex-wrap gap-3 text-sm">
                        ${song.genre ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${song.genre}</span>` : ''}
                        ${song.location ? `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">üìç ${song.location}</span>` : ''}
                        ${song.years_active ? `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">üéµ ${song.years_active}</span>` : ''}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col gap-3 lg:flex-row lg:items-center">
                    <button onclick="voteForSong(${song.id}, '${song.title || 'Untitled'}')" 
                            class="bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-dark transition-colors flex items-center gap-2">
                        <span>üó≥Ô∏è</span>
                        Vote
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Get rank badge for top 3
function getRankBadge(rank) {
    const badges = {
        1: '<span class="text-yellow-500 text-2xl">ü•á</span>',
        2: '<span class="text-gray-400 text-2xl">ü•à</span>',
        3: '<span class="text-orange-500 text-2xl">ü•â</span>'
    };
    return badges[rank] || '';
}

// Vote for a song
async function voteForSong(songId, songTitle) {
    console.log('Vote button clicked for:', songId, songTitle);
    selectedSongId = songId;
    
    // Show browser notification
    if ('Notification' in window) {
        console.log('Notification permission status:', Notification.permission);
        
        if (Notification.permission === 'granted') {
            try {
                new Notification('Vote Confirmation', {
                    body: `Voting for "${songTitle}"...`,
                    icon: '/static/favicon.ico'
                });
                console.log('Vote confirmation notification sent');
            } catch (error) {
                console.error('Error showing notification:', error);
            }
        } else if (Notification.permission === 'default') {
            console.log('Requesting notification permission...');
            const permission = await Notification.requestPermission();
            console.log('Permission result:', permission);
        }
    } else {
        console.log('Notifications not supported in this browser');
    }
    
    // Immediately proceed with voting
    await confirmVote();
}

// Confirm vote
async function confirmVote() {
    if (!selectedSongId) {
        console.log('No song selected for voting');
        return;
    }
    
    console.log('Processing vote for song ID:', selectedSongId);
    
    try {
        const response = await fetch('/api/voting/vote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                song_id: selectedSongId,
                recaptcha_token: 'demo' // TODO: Add real reCAPTCHA
            })
        });
        
        console.log('Vote response status:', response.status);
        
        if (response.status === 401) {
            showError('Please log in to vote. You need an account to participate.');
            return;
        }
        
        const result = await response.json();
        console.log('Vote response result:', result);
        
        if (response.ok) {
            // Show success notification
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    new Notification('Vote Successful!', {
                        body: 'Your vote has been recorded.',
                        icon: '/static/favicon.ico'
                    });
                    console.log('Success notification sent');
                } catch (error) {
                    console.error('Error showing success notification:', error);
                }
            }
            
            showSuccess('Vote recorded successfully!');
            // Reload songs to update vote counts
            loadSongs(1);
        } else {
            showError(result.detail || 'Failed to record vote. Please try again.');
        }
    } catch (error) {
        console.error('Error voting:', error);
        showError('Failed to record vote. Please try again.');
    }
    
    // Reset selected song
    selectedSongId = null;
}





// Update stats
async function updateStats() {
    try {
        const response = await fetch('/api/voting/stats');
        const stats = await response.json();
        
        document.getElementById('totalSongs').textContent = stats.total_songs || 0;
        document.getElementById('totalVotes').textContent = stats.total_votes || 0;
        document.getElementById('activeVoters').textContent = stats.country_breakdown?.length || 0;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Load more songs
function loadMoreSongs() {
    loadSongs(currentPage + 1);
}

// Show success message
function showSuccess(message) {
    // Try browser notification first
    if ('Notification' in window && Notification.permission === 'granted') {
        try {
            new Notification('Success!', {
                body: message,
                icon: '/static/favicon.ico'
            });
        } catch (error) {
            console.error('Error showing notification:', error);
            alert('Success: ' + message);
        }
    } else {
        // Fallback to alert
        alert('Success: ' + message);
    }
}

// Show error message
function showError(message) {
    // Simple error notification - you can enhance this
    alert('Error: ' + message);
}

// Event listeners
document.getElementById('loadMoreBtn').addEventListener('click', loadMoreSongs);
</script>
{% endblock %}
